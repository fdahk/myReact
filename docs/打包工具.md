前端应用打包后部署上线
Vite、Webpack、Rollup 等工具打包生成的静态资源（React/Vue/纯静态站点、SPA/MPA）。

一、产物与目录
1) 默认构建目录：Vite 为 dist/，Webpack 常见为 dist/。
2) 产物类型：index.html、带哈希的 js/css 资源、字体与图片等静态文件。
3) 核心：将 dist/ 内全部文件部署到可被 HTTP/HTTPS 访问的静态资源服务器或对象存储+CDN。

二、部署方式
1) Nginx 静态服务（最常见、可控性强）
   - 将 dist/ 同步至服务器目录（如 /var/www/app）。
   - 配好 Nginx 虚拟主机与缓存/压缩/SPA 回退规则。

2) 对象存储 + CDN（S3+CloudFront、阿里 OSS+CDN、七牛等）
   - 上传 dist/ 到桶，开启 CDN，配置缓存与回源。
   - SPA 场景下需配置 404 回退到 /index.html。

3) 静态托管平台（Vercel、Netlify、GitHub Pages、Cloudflare Pages）
   - 连接仓库、一键构建部署，适合中小项目与预览环境。

4) Node 静态服务（临时/简单）
   - 使用 serve/express 静态托管 dist/。（生产更建议 Nginx 或 CDN）

5) Docker 镜像部署
   - 使用 nginx:alpine 作为运行镜像，COPY dist/ 到 /usr/share/nginx/html。
   - 在容器内配置 Nginx 并暴露 80/443。

三、Nginx 示例（SPA，含回退与缓存）

server {
    listen 80;
    server_name example.com;  # 域名
    root /var/www/app;        # dist 同步到此目录

    # 压缩与常规头部可按需开启
    gzip on;
    gzip_types text/css application/javascript application/json image/svg+xml;

    # 对哈希文件设置长缓存，对 HTML 关缓存
    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
    }

    location = /index.html {
        add_header Cache-Control "no-store";
    }

    # SPA 路由回退
    location / {
        try_files $uri $uri/ /index.html;
    }
}

四、对象存储 + CDN
1) 确保设置正确的 MIME（.js 为 text/javascript；.css 为 text/css）。
2) 静态资源（带哈希文件）设置长缓存，index.html 不缓存或极短缓存。
3) SPA 需配置 404/缺省文档回退到 index.html（各平台命名不同）。
4) 开启 Gzip/Brotli（CDN 或边缘侧）。

五、Docker 部署示例

# Dockerfile
FROM nginx:alpine
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY dist/ /usr/share/nginx/html

# nginx.conf（与上方 Nginx 规则类似）
server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;

    gzip on;
    gzip_types text/css application/javascript application/json image/svg+xml;

    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
    }

    location = /index.html {
        add_header Cache-Control "no-store";
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}

六、GitHub Actions（例：部署到 GitHub Pages）

# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [ "main" ]
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: corepack enable && pnpm i --frozen-lockfile
      - run: pnpm build
      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist
      - uses: actions/deploy-pages@v4

七、环境变量与配置
1) 构建期变量：Vite 使用 import.meta.env 与 .env* 文件；注意敏感信息不要打进前端包。
2) 运行期注入：可在 index.html 注入 window.__APP_CONFIG__ 或加载 /config.json，避免重新构建即可切换环境。
3) Nginx 注入：通过模板或启动脚本渲染配置，再启动 Nginx。

八、常见问题
1) 刷新 404：SPA 必须配置回退到 /index.html（Nginx try_files、CDN 自定义错误页）。
2) 资源缓存失效：确保产物使用内容哈希并对静态文件配置长缓存，HTML 不缓存。
3) MIME 错误：对象存储或 Nginx 的类型映射需正确。
4) base 路径：Vite 的 base 需与部署路径一致（例如二级目录 /app/）。
5) CORS：前端调用后端 API 时，后端需允许跨域或通过同域代理。

九、上线检查
- 域名与 HTTPS（证书有效、HSTS 可选）。
- SPA 刷新与直连深链正常。
- CDN 命中率与缓存策略符合预期（index.html 不缓存）。
- Gzip/Brotli 生效，首屏与总下载量达标。
- 监控与日志（前端报错、性能、可用性）。
- 回滚方案（灰度发布、版本回退、CDN 回源/回滚）。

十、最简流程（Nginx 版本）
1) 本地/CI 执行构建：pnpm build（产物在 dist/）。
2) 将 dist/ 同步到服务器：rsync/scp 到 /var/www/app。
3) 配置 Nginx（如上）并 reload。
4) 打开域名验证路由、缓存和压缩是否正常。

附：Node 简易静态托管（临时方案）

# 安装并运行
npm i -g serve
serve -s dist -l 5173

生产建议使用 Nginx/CDN，便于缓存、压缩、HTTPS 与可观测性。


